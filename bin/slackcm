#!/bin/bash
##############################################################################
# slackpm
# -----------
# Send a message to a channel on slack
#
# Usage:
# 	slackpm [channel] [message]
#
# :authors: Chris Marshall, @codegoalie
# :date: 19 Aug 2016
# :version: 0.0.1
# This is just a modified version of @jfrazelle's https://github.com/jfrazelle/dotfiles/blob/master/bin/slackpm
##############################################################################
set -e
set -o pipefail

# Print a usage message and exit.
usage(){
	local name=$(basename "$0")

	cat >&2 <<-EOF
	${name} [channel] [message]

	You will also need to set \$SLACK_TOKEN for authentication.
	You can generate a Web Api Token here: https://api.slack.com/web
	EOF
	exit 1
}

[ "$SLACK_TOKEN" ] || usage

# Print usage with --help or -h
if [ "$#" -lt 2 ]; then
	usage;
fi

send_message(){
	local channel=$1
	local message=${*:2}

	local postresp=$(curl -sSL -X POST \
		--data-urlencode "token=${SLACK_TOKEN}" \
		--data-urlencode "channel=#${channel}" \
		--data-urlencode "text=${message}" \
		--data-urlencode "as_user=1" \
		https://slack.com/api/chat.postMessage)

	echo "$postresp" | jq .
}

send_message "$@"
